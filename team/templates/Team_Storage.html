{% extends 'index.html' %}

{% block title %}Team Storage Page{% endblock %}

{% block content %}
<style>
    .notice-list {
        width: 100%;
        height: 30%;
    }

    .directory-list {
        width: 100%;
        height: 50%;
    }

    .button {
        float: right;
    }
</style>

<body>
    <h1>{{name}} Team Storage</h1>
    <div id='noticelist' class="notice-list">
        {% if team_descript != "" %}
        <h3>Descript : {{team_descript}}</h3>
        {% endif %}
        <table>
            <thead>
                <th scope="col">NOTICE</th>
                <th scope="col">DATE</th>
            </thead>
            <tbody>
                {% if notice %}
                {% for list in notice %}
                <tr>
                    <td><a href="#" onclick="location.href='/team/team_notice?title={{list.title}}&url='+location.href;" >{{list.title}}</a></td>
                    <td>{{list.input_time|date:"Y-m-d P"}}</td>
                </tr>
                {% endfor %}
                {% else %}
                <tr>
                    <td colspan="*">공지사항이 없습니다.</td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
    <div id="filelist" class="directory-list">
        {% if folder != "top" %}
        <input type="button" value="상위 폴더로 이동" onclick="uptofolder();">
        {% endif %}
        <table>
            <thead>
                <th></th>
                <th scope="col">FILES</th>
                <th scope="col">MEMO</th>
            </thead>
            <tbody id="tbody">
                {% if data %}
                {% for list in data %}
                <tr>
                    <td><input type='checkbox' name='check_files' value='{{list.filename}}'></td>
                    <td>{% if "." in list.filename %}
                        {{list.filename}}
                        {% else %}
                        <a href="/team/tsmovefolder?dir={{list.filename}}">{{list.filename}}</a>
                        {% endif %}
                    </td>
                    <td>{{list.descript|default:""}}</td>
                </tr>
                {% endfor %}
                {% else %}
                <tr>
                    <td colspan="*">저장된 정보가 없습니다.</td>
                </tr>
                {% endif %}
            </tbody>
        </table>
        <br />
        <input type="button" value="Add Folder" onclick="create_folder();">
    </div>
    <div id="upload" class="button">
        {% if user_auth == 0 %}
        <input type="button" value="Delete" onclick="delete_files();">
        {% endif %}
        <input type="button" value="Upload" onclick="location.href='/team/ts_file_upload?url='+location.href;">
        <input type="button" value="Download" onclick="download_files()">
    </div>
    <a id="file_download" href="" download hidden></a>
</body>
<script>
    function create_folder() {
        var folder_name = prompt("폴더 이름을 입력해주세요.", "폴더 이름");
        if (folder_name != null) {
            var descript = prompt("추가할 메모를 적어주세요.", "");
            if (descript == null) {
                return;
            }
            var auth;
            var user_auth = Number("{{user_auth}}");
            if(user_auth == 0){
                user_auth = 1;
            }
            if(Number("{{team_auth}}") == 1){
                auth = 1;
            } else if(Number("{{team_auth}}") == user_auth){
                auth = Number("{{team_auth}}");
            } else {
                auth = Number("{{team_auth}}");
                auth = prompt("열람가능 권한을 적어주세요", "(" + user_auth + "~{{team_auth}})");
                if(auth == null){
                    return;
                }
                while(Number(auth) > Number("{{team_auth}}") || Number(auth) < user_auth || auth.length != 1){
                    auth = prompt("다시 적어주세요", "(" + user_auth + "~{{team_auth}})");
                    if(auth == null){
                        return;
                    }
                }
            }
            var data = { "folder_name": folder_name, "descript": descript, "auth" : auth };
            $.ajax({
                url: "{% url 'tsaddfolder' %}",
                type: 'GET',
                data: data,
                success: function (result) {
                    alert(result);
                    location.reload();
                },
                error: function (request, status, error) {
                    alert("code:" + request.status + "\n" + "message:" + request.responseText + "\n" + "error:" + error);
                }
            });
        }
    }

    function uptofolder(){
        $.ajax({
            url: "{% url 'uptofolder' %}",
            type: 'GET',
            success: function (result) {
                if(result == "top"){
                    location.href = "{% url 'team_storage' %}";
                } else {
                    location.href = "/team/?dir=" + result;
                }
            },
            error: function (request, status, error) {
                alert("code:" + request.status + "\n" + "message:" + request.responseText + "\n" + "error:" + error);
            }
        });
    }

    function delete_files() {
        var filename_array = new Array();

        // check 항목 받아옴
        $("input:checkbox[name=check_files]:checked").each(function () {
            filename_array.push($(this).val());
        })

        var formData = new FormData();

        var array = JSON.stringify({ 'array': filename_array })

        formData.append('filename', array);

        if (confirm("정말 삭제하시겠습니까?")) {
            $.ajax({
                url: "{% url 'tsdeletefile' %}",
                data: formData,  //위에서 선언한 fromdata
                processData: false,  // 데이터 객체를 문자열로 바꿀지에 대한 값이다. true면 일반문자...
                contentType: false,  // 해당 타입을 true로 하면 일반 text로 구분되어 진다.
                type: 'POST',
                success: function (result) {
                    alert("삭제가 완료되었습니다.");
                    location.reload();
                },
                error: function (request, status, error) {
                    alert("code:" + request.status + "\n" + "message:" + request.responseText + "\n" + "error:" + error);
                }
            });
        }
    }

    function download_files() {
        var check_count = $("input:checkbox[name=check_files]:checked").length;

        if (check_count == 1 && $("input:checkbox[name=check_files]:checked").val().indexOf(".") != -1) {
            var file = $("input:checkbox[name=check_files]:checked").val();

            var a = $("#file_download");

            a.attr("href", "/download?filename=" + file);

            a.get(0).click();

            a.attr("href", "");
        } else {
            var filename_array = new Array();

            // check 항목 받아옴
            $("input:checkbox[name=check_files]:checked").each(function () {
                filename_array.push($(this).val());
            })

            var formData = new FormData();

            var array = JSON.stringify({ 'array': filename_array })

            formData.append('filename', array);

            $.ajax({
                url: "{% url 'zipping' %}",
                data: formData,  //위에서 선언한 fromdata
                processData: false,  // 데이터 객체를 문자열로 바꿀지에 대한 값이다. true면 일반문자...
                contentType: false,  // 해당 타입을 true로 하면 일반 text로 구분되어 진다.
                type: 'POST',
                success: function (result) {
                    var a = $("#file_download");

                    a.attr("href", "/zipdownload?path=" + result);

                    a.get(0).click();

                    a.attr("href", "");
                },
                error: function (request, status, error) {
                    alert("code:" + request.status + "\n" + "message:" + request.responseText + "\n" + "error:" + error);
                }
            });
        }
    }
</script>
{% endblock %}