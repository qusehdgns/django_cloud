{% extends 'index.html' %}

{% block title %}TS File Upload Page{% endblock %}

{% block content %}
<h1>TS File Upload</h1>
<p><input id='file' type='file' onchange="changetable();" multiple></p>
<div id="file_list">
    <table>
        <thead>
            <th scope="col">NO</th>
            <th scope="col">FILE NAME</th>
            <th scope="col">ADD MEMO</th>
            {% if team_auth != 1 %}
            <th scope="col">AUTHORITY</th>
            {% endif %}
        </thead>
        <tbody id="tbody">
        </tbody>
    </table>
</div>
<p />
<input type="button" value="Upload Files" onclick="file_upload();">
<input type="button" value="Cancel" onclick="location.href = '{{url}}';">

<script>
    var count = 0;

    function changetable() {
        $('#tbody').empty();
        count = 0;

        var file = $('#file')[0].files;

        for (var i = 0; i < file.length; i++) {
            var tbody = document.all["tbody"].insertRow();
            var cell0 = tbody.insertCell(0);
            var cell1 = tbody.insertCell(1);
            var cell2 = tbody.insertCell(2);

            cell0.innerHTML = "<td></td>";
            cell1.innerHTML = "<td>" + file[i].name + "</td>";
            cell2.innerHTML = "<td><input type='text' id='" + i + "'></td>";

            if ("{{team_auth}}" != "1") {
                var cell3 = tbody.insertCell(3);
                cell3.innerHTML = "<select id='select_auth" + i + "'><option value='{{team_auth}}'>권한선택</option>"
                    + "{% for i in range %}<option value='{{i}}'>{{i}}</option>{% endfor %}"
                    + "</select>";
            } else {
                if (count == 0) {
                    $('#file_list').append("<input type='hidden' id='select_auth' value='{{team_auth}}'>");
                    count = 1;
                }
            }
        }
    }

    function file_upload() {
        var file = $('#file')[0].files;

        var files = Array.prototype.slice.call(file);

        var s_count = 0;
        var f_count = 0;

        for (var i in files) {
            var descript = $('#' + i).val();
            var ts_auth;
            if(count == 0){
                ts_auth = $('#select_auth' + i + ' option:selected').val();
            } else {
                ts_auth = $('#select_auth').val();
            }
            var formData = new FormData();
            formData.append("filename", files[i].name);
            formData.append("file", files[i]);
            formData.append("descript", descript);
            formData.append("access_auth", ts_auth);
            

            $.ajax({
                url: "{% url 'team_file_upload' %}",
                data: formData,  //위에서 선언한 fromdata
                processData: false,  // 데이터 객체를 문자열로 바꿀지에 대한 값이다. true면 일반문자...
                contentType: false,  // 해당 타입을 true로 하면 일반 text로 구분되어 진다.
                type: 'POST',
                async: false,   // 순차적 진행
                success: function (result) {
                    if (result == "success") {
                        s_count++;
                    } else {
                        f_count++;
                    }
                },
                error: function (request, status, error) {
                    alert("code:" + request.status + "\n" + "message:" + request.responseText + "\n" + "error:" + error);
                }
            });
        }
        alert(s_count + "개의 파일 업로드 성공\n" + f_count + "개의 파일 업로드 실패");
        location.href = "{{url}}";
    }
</script>
{% endblock %}