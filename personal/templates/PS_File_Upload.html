{% extends 'index.html' %}

{% block title %}PS File Upload Page{% endblock %}

{% block content %}

<body class="p">
    <div class="directory-list">
        <nav>
            <h1 class="na">File Upload</h1>
        </nav>

        <div id="list" style="margin-left:350px; margin-right:100px;">
            <div style="margin-top:30px;">
                <div style="display:inline-block;" class="filebox">
                    <label for="file">Upload</label>
                    <input id='file' type='file' onchange="changetable();" multiple>
                </div>
                <div style="display:inline;">
                    <input class="b2 fr" type="button" value="Upload Files" onclick="file_check();">
                    <input class="b1 fr" type="button" value="Go to Back" onclick="location.href = '{{url}}';">
                </div>
            </div>
        </div>

        <div style="margin-left:350px; margin-right:100px;">
            <table class="table PS_U">
                <thead>
                    <th scope="col">NO</th>
                    <th scope="col">FILE NAME</th>
                    <th scope="col">ADD MEMO</th>
                </thead>
                <tbody id="tbody">
                </tbody>
            </table>
        </div>


        <div id="filecolor_dialog" style="display: none;">
            <h1>파일 확인 중...</h1>
        </div>
        <div id="filecheck_dialog" style="display: none;">
            <h1>파일 중복 검사 중...</h1>
        </div>
        <div id="fileupload_dialog" style="display: none;">
            <h1>파일 업로드 중...</h1>
        </div>
    </div>
</body>

<script>
    function deleteLine(obj) {
        var tr = $(obj).parent().parent();
        var index = $(obj).parent().parent().parent().children().index(tr);
        tr.remove();
        files.splice(index, 1);
    }

    var files = undefined;

    function changetable() {
        $('#tbody').empty();

        var file = $('#file')[0].files;

        for (var i = 0; i < file.length; i++) {
            var tbody = document.all["tbody"].insertRow();
            var cell0 = tbody.insertCell(0);
            var cell1 = tbody.insertCell(1);
            var cell2 = tbody.insertCell(2);
            var cell3 = tbody.insertCell(3);

            var temp = file[i].name.replace(".", "").replaceAll(" ", "_");

            cell0.innerHTML = "<td></td>";
            cell1.innerHTML = "<td><span style='color:rgba(255,255,255,0.8);' id='" + temp + "' style=''>" + file[i].name + "</span></td>";
            cell2.innerHTML = "<td><input class='add_memo' type='text'></td>";
            cell3.innerHTML = "<td><input class='btn_del' type='button' onclick='deleteLine(this);' value = 'X''></td>";
        }

        var file = $('#file')[0].files;

        files = Array.prototype.slice.call(file);

        file_color();
    }

    function file_color() {
        var filenameform = new FormData();

        var filenames = new Array();

        $("#filecolor_dialog").dialog({
            modal: true,
            width: 'auto',
            closeOnEscape: false,
            open: function (event, ui) {
                $(".ui-dialog-titlebar-close", $(this).parent()).hide();
            }
        });

        for (var i in files) {
            filenames.push(files[i].name);
        }

        var array = JSON.stringify({ 'array': filenames });

        filenameform.append('filenames', array);

        $.ajax({
            url: "{% url 'psfilecheck' %}",
            data: filenameform,  //위에서 선언한 fromdata
            processData: false,  // 데이터 객체를 문자열로 바꿀지에 대한 값이다. true면 일반문자...
            contentType: false,  // 해당 타입을 true로 하면 일반 text로 구분되어 진다.
            type: 'POST',
            async: false,   // 순차적 진행
            success: function (result) {
                $('#filecolor_dialog').dialog('close');
                for (var i in result.array) {
                    var temp = result.array[i].replace(".", "").replaceAll(" ", "_");
                    $('#' + temp).css("color", "orange");
                }

            },
            error: function (request, status, error) {
                alert("code:" + request.status + "\n" + "message:" + request.responseText + "\n" + "error:" + error);
            }
        });
    }

    function file_check() {
        var filenameform = new FormData();

        var filenames = new Array();

        $("#filecheck_dialog").dialog({
            modal: true,
            width: 'auto',
            closeOnEscape: false,
            open: function (event, ui) {
                $(".ui-dialog-titlebar-close", $(this).parent()).hide();
            }
        });

        for (var i in files) {
            filenames.push(files[i].name);
        }

        var array = JSON.stringify({ 'array': filenames });

        filenameform.append('filenames', array);

        $.ajax({
            url: "{% url 'psfilecheck' %}",
            data: filenameform,  //위에서 선언한 fromdata
            processData: false,  // 데이터 객체를 문자열로 바꿀지에 대한 값이다. true면 일반문자...
            contentType: false,  // 해당 타입을 true로 하면 일반 text로 구분되어 진다.
            type: 'POST',
            async: false,   // 순차적 진행
            success: function (result) {
                $('#filecheck_dialog').dialog('close');
                if (result.array.length != 0) {
                    var show = result.array[0];
                    for (var i = 1; i < result.array.length; i++) {
                        show = show + ", " + result.array[i];
                    }
                    if (confirm(show + "가 중복 파일입니다.\n덮어쓰기 하시겠습니까?")) {
                        file_upload();
                    }
                } else {
                    file_upload();
                }
            },
            error: function (request, status, error) {
                alert("code:" + request.status + "\n" + "message:" + request.responseText + "\n" + "error:" + error);
            }
        });
    }

    function file_upload() {
        var s_count = 0;
        var f_count = 0;

        $("#fileupload_dialog").dialog({
            modal: true,
            width: 'auto',
            closeOnEscape: false,
            open: function (event, ui) {
                $(".ui-dialog-titlebar-close", $(this).parent()).hide();
            }
        });

        for (var i in files) {
            var temp = files[i].name.replace(".", "").replaceAll(" ", "_");

            var descript = $('#' + temp).parent().parent().children().eq(2).children().val();
            var formData = new FormData();
            formData.append("filename", files[i].name)
            formData.append("file", files[i]);
            formData.append("descript", descript)

            $.ajax({
                url: "{% url 'personal_file_upload' %}",
                data: formData,  //위에서 선언한 fromdata
                processData: false,  // 데이터 객체를 문자열로 바꿀지에 대한 값이다. true면 일반문자...
                contentType: false,  // 해당 타입을 true로 하면 일반 text로 구분되어 진다.
                type: 'POST',
                async: false,   // 순차적 진행
                success: function (result) {
                    if (result == "success") {
                        s_count++;
                    } else {
                        f_count++;
                    }
                },
                error: function (request, status, error) {
                    alert("code:" + request.status + "\n" + "message:" + request.responseText + "\n" + "error:" + error);
                }
            });
        }

        $('#fileupload_dialog').dialog('close');
        alert(s_count + "개의 파일 업로드 성공\n" + f_count + "개의 파일 업로드 실패");
        location.href = "{{url}}";
    }
</script>
{% endblock %}