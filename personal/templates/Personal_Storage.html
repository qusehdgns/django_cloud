{% extends 'index.html' %}

{% block title %}Personal Storage Page{% endblock %}

{% block content %}
<style>
    .directory-list {
        margin: auto;
        width: 100%;
        height: 80%;
    }

    .button {
        float: right;
    }
</style>

<body>
    <h1>{{userid}}'s Personal Storage</h1>
    <div id="list" class="directory-list">
        {% if folder != "top" %}
        <input type="button" value="상위 폴더로 이동" onclick="uptofolder();">
        {% endif %}
        <table>
            <thead>
                <th></th>
                <th scope="col">FILES</th>
                <th scope="col">MEMO</th>
            </thead>
            <tbody id="tbody">
                {% if data %}
                {% for list in data %}
                <tr>
                    <td><input type='checkbox' name='check_files' value='{{list.filename}}'></td>
                    <td>{% if "." in list.filename %}
                        <a href="/download?filename={{list.filename}}" download>{{list.filename}}</a>
                        {% else %}
                        <a href="/personal/psmovefolder?dir={{list.filename}}">{{list.filename}}</a>
                        {% endif %}
                    </td>
                    <td>{{list.descript|default:""}}</td>
                </tr>
                {% endfor %}
                {% else %}
                <tr>
                    <td colspan="*">저장된 정보가 없습니다.</td>
                </tr>
                {% endif %}
            </tbody>
        </table>
        <br />
        <input type="button" value="Add Folder" onclick="create_folder();">
    </div>
    <div id="upload" class="button">
        <input type="button" value="Delete" onclick="delete_files();">
        <input type="button" value="Upload" onclick="location.href='/personal/ps_file_upload?url='+location.href;">
        <input type="button" value="Download" onclick="">
    </div>
</body>
<script>
    function create_folder() {
        var folder_name = prompt("폴더 이름을 입력해주세요.", "폴더 이름");
        if (folder_name != null) {
            var descript = prompt("추가할 메모를 적어주세요.");
            if (descript == null) {
                descript = "";
            }
            var data = { "folder_name": folder_name, "descript": descript };
            $.ajax({
                url: "{% url 'psaddfolder' %}",
                type: 'GET',
                data: data,
                success: function (result) {
                    alert(result);
                    location.reload();
                },
                error: function (request, status, error) {
                    alert("code:" + request.status + "\n" + "message:" + request.responseText + "\n" + "error:" + error);
                }
            });
        }
    }

    function uptofolder() {
        $.ajax({
            url: "{% url 'uptofolder' %}",
            type: 'GET',
            success: function (result) {
                if (result == "top") {
                    location.href = "{% url 'personal_storage' %}";
                } else {
                    location.href = "/personal/?dir=" + result;
                }
            },
            error: function (request, status, error) {
                alert("code:" + request.status + "\n" + "message:" + request.responseText + "\n" + "error:" + error);
            }
        });
    }

    function delete_files() {
        var filename_array = new Array();

        // check 항목 받아옴
        $("input:checkbox[name=check_files]:checked").each(function () {
            filename_array.push($(this).val());
        })

        var formData = new FormData();

        var array = JSON.stringify({ 'array' : filename_array})

        formData.append('filename', array);

        if (confirm("정말 삭제하시겠습니까?")) {
            $.ajax({
                url: "{% url 'psdeletefile' %}",
                data: formData,  //위에서 선언한 fromdata
                processData: false,  // 데이터 객체를 문자열로 바꿀지에 대한 값이다. true면 일반문자...
                contentType: false,  // 해당 타입을 true로 하면 일반 text로 구분되어 진다.
                type: 'POST',
                success: function (result) {
                    alert("삭제가 완료되었습니다.");
                    location.reload();
                },
                error: function (request, status, error) {
                    alert("code:" + request.status + "\n" + "message:" + request.responseText + "\n" + "error:" + error);
                }
            })
        }
    }
</script>
{% endblock %}